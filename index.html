<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>下午茶點餐系統</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: auto; padding: 20px; }
    img { max-width: 100%; height: auto; margin-bottom: 20px; }
    input, button, select { margin: 5px 0; padding: 5px; }
    .item-group { display: flex; gap: 10px; margin-bottom: 10px; }
    .summary { background: #f8f8f8; padding: 10px; margin-top: 20px; }
    @media screen and (max-width: 600px) {
      body { padding: 10px; }
      .item-group { flex-direction: column; }
    }
  </style>
</head>
<body>
  <h2>下午茶點餐系統</h2>
  <img src="menu.jpg" alt="菜單圖片">
  <form id="orderForm">
    <label>姓名：<br><input type="text" id="name" name="name" required></label><br>

    <div id="food-section">
      <label>食物：</label><br>
      <div class="item-group">
        <input type="text" name="food">
        <button type="button" onclick="addItem('food-section', 'food')">＋</button>
      </div>
    </div>

    <div id="drink-section">
      <label>飲料：</label><br>
      <div class="item-group">
        <input type="text" name="drink">
        <button type="button" onclick="addItem('drink-section', 'drink')">＋</button>
      </div>
    </div>

    <button type="submit">送出 / 更新</button>
  </form>

  <div class="summary">
    <h3>統計結果</h3>
    <div id="summary"></div>
    <button onclick="exportToExcel()">⬇ 匯出 Excel</button>
  </div>

  <div>
    <h3>所有點餐</h3>
    <ul id="orderList"></ul>
  </div>

<script>
  const scriptURL = "https://script.google.com/macros/s/AKfycbwuX32uSPHxcql7M9aUSGSAgIdpEG3zHn4nQNiPCYsIESsZcJUCi32M1w2ZDOa9_5C1/exec";

  function addItem(sectionId, name) {
    const section = document.getElementById(sectionId);
    const div = document.createElement("div");
    div.className = "item-group";
    div.innerHTML = `<input type="text" name="${name}"> <button type="button" onclick="this.parentElement.remove()">－</button>`;
    section.appendChild(div);
  }

  const form = document.getElementById("orderForm");
  form.addEventListener("submit", e => {
    e.preventDefault();
    const name = document.getElementById("name").value.trim();
    const foods = Array.from(document.querySelectorAll("input[name=food]")).map(f => f.value).filter(Boolean);
    const drinks = Array.from(document.querySelectorAll("input[name=drink]")).map(f => f.value).filter(Boolean);
    const formData = new FormData();
    formData.append("name", name);
    formData.append("food", foods.join(", "));
    formData.append("drink", drinks.join(", "));
    fetch(scriptURL, { method: 'POST', body: formData })
      .then(() => { form.reset(); loadOrders(); });
  });

  function loadOrders() {
    fetch(scriptURL + "?action=get")
      .then(res => res.json())
      .then(data => {
        const orderList = document.getElementById("orderList");
        const summary = document.getElementById("summary");
        orderList.innerHTML = "";
        const foodCount = {}, drinkCount = {};
        data.forEach(([name, food, drink]) => {
          orderList.innerHTML += `<li>${name}：🍱 ${food} 🧋 ${drink}</li>`;
          food.split(/,|\s+/).forEach(f => { if(f) foodCount[f] = (foodCount[f]||0)+1; });
          drink.split(/,|\s+/).forEach(d => { if(d) drinkCount[d] = (drinkCount[d]||0)+1; });
        });
        summary.innerHTML =
          "🍱 食物：<br>" + Object.entries(foodCount).map(([k,v])=>`${k}: ${v}`).join("<br>") +
          "<br><br>🧋 飲料：<br>" + Object.entries(drinkCount).map(([k,v])=>`${k}: ${v}`).join("<br>");
      });
  }

  function exportToExcel() {
    window.open(scriptURL + "?action=export");
  }

  document.getElementById("name").addEventListener("blur", () => {
    const name = document.getElementById("name").value.trim();
    fetch(scriptURL + "?action=get")
      .then(res => res.json())
      .then(data => {
        const record = data.find(row => row[0] === name);
        if (record) {
          const [_, food, drink] = record;
          document.getElementById("food-section").innerHTML = "<label>食物：</label><br>";
          food.split(/,|\s+/).filter(Boolean).forEach(f => addItemValue("food-section", "food", f));
          document.getElementById("drink-section").innerHTML = "<label>飲料：</label><br>";
          drink.split(/,|\s+/).filter(Boolean).forEach(d => addItemValue("drink-section", "drink", d));
        }
      });
  });

  function addItemValue(sectionId, name, value) {
    const section = document.getElementById(sectionId);
    const div = document.createElement("div");
    div.className = "item-group";
    div.innerHTML = `<input type="text" name="${name}" value="${value}"> <button type="button" onclick="this.parentElement.remove()">－</button>`;
    section.appendChild(div);
  }

  loadOrders();
</script>
</body>
</html>
