<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>下午茶點餐系統</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: auto; padding: 20px; }
    img { max-width: 100%; height: auto; margin-bottom: 20px; }
    input, button { margin: 5px 0; padding: 5px; }
    .item-group { display: flex; gap: 10px; margin-bottom: 10px; }
    .summary { background: #f8f8f8; padding: 10px; margin-top: 20px; }
    button { cursor: pointer; }
    @media screen and (max-width: 600px) {
      body { padding: 10px; }
      .item-group { flex-direction: column; }
    }
  </style>
</head>
<body>
  <h2>下午茶點餐系統</h2>
  <img src="IMG_3037.jpeg" alt="菜單圖片" />

  <form id="orderForm">
    <label>姓名：<br><input type="text" id="name" name="name" required></label><br>

    <div id="food-section"></div>
    <div id="drink-section"></div>

    <button type="submit">送出 / 更新</button>
  </form>

  <div class="summary">
    <h3>統計結果</h3>
    <div id="summary"></div>
    <button onclick="exportToExcel()">⬇ 匯出 Excel</button>
  </div>

  <div>
    <h3>所有點餐</h3>
    <ul id="orderList"></ul>
  </div>

<script>
  const scriptURL = "https://script.google.com/macros/s/AKfycbzUFkQOEkIh7CJNXP86C_mO-rFcXwFJvcvv0j0JW78graRxyhfKBtNB7OY3t03eCK35/exec";

  function renderItemSection(sectionId, name, items = []) {
    const section = document.getElementById(sectionId);
    const label = name === 'food' ? '食物' : '飲料';
    section.innerHTML = `<label>${label}：</label><br>`;

    items.forEach(value => {
      const div = document.createElement("div");
      div.className = "item-group";
      div.innerHTML = `<input type="text" name="${name}" value="${value}"> 
                       <button type="button" onclick="this.parentElement.remove()">－</button>`;
      section.appendChild(div);
    });

    const addDiv = document.createElement("div");
    addDiv.className = "item-group";
    const addBtn = document.createElement("button");
    addBtn.type = "button";
    addBtn.textContent = `＋ 新增${label}`;
    addBtn.onclick = () => {
      const div = document.createElement("div");
      div.className = "item-group";
      div.innerHTML = `<input type="text" name="${name}"> 
                       <button type="button" onclick="this.parentElement.remove()">－</button>`;
      section.insertBefore(div, addDiv);
    };
    addDiv.appendChild(addBtn);
    section.appendChild(addDiv);
  }

  const form = document.getElementById("orderForm");
  form.addEventListener("submit", e => {
    e.preventDefault();
    const name = document.getElementById("name").value.trim();
    const foods = Array.from(document.querySelectorAll("input[name=food]")).map(f => f.value).filter(Boolean);
    const drinks = Array.from(document.querySelectorAll("input[name=drink]")).map(f => f.value).filter(Boolean);
    const formData = new FormData();
    formData.append("name", name);
    formData.append("food", foods.join(", "));
    formData.append("drink", drinks.join(", "));
    fetch(scriptURL, { method: 'POST', body: formData })
      .then(() => { form.reset(); renderItemSection("food-section", "food"); renderItemSection("drink-section", "drink"); loadOrders(); });
  });

  function loadOrders() {
    fetch(scriptURL + "?action=get")
      .then(res => res.json())
      .then(data => {
        const orderList = document.getElementById("orderList");
        const summary = document.getElementById("summary");
        orderList.innerHTML = "";
        const foodCount = {}, drinkCount = {};
        data.forEach(([name, food, drink]) => {
          orderList.innerHTML += `<li>${name}：🍱 ${food} 🧋 ${drink}</li>`;
          food.split(/,|\s+/).forEach(f => { if(f) foodCount[f] = (foodCount[f]||0)+1; });
          drink.split(/,|\s+/).forEach(d => { if(d) drinkCount[d] = (drinkCount[d]||0)+1; });
        });
        summary.innerHTML =
          "🍱 食物：<br>" + Object.entries(foodCount).map(([k,v])=>`${k}: ${v}`).join("<br>") +
          "<br><br>🧋 飲料：<br>" + Object.entries(drinkCount).map(([k,v])=>`${k}: ${v}`).join("<br>");
      });
  }

  function exportToExcel() {
  fetch(scriptURL + "?action=export")
    .then(response => {
      if (!response.ok) throw new Error("下載失敗：" + response.statusText);
      return response.blob();
    })
    .then(blob => {
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "下午茶點餐統計.xlsx";
      a.click();
      window.URL.revokeObjectURL(url);
    })
    .catch(error => {
      alert("下載錯誤：" + error.message);
    });
}



  document.getElementById("name").addEventListener("blur", () => {
    const name = document.getElementById("name").value.trim();
    if (!name) return;
    fetch(scriptURL + "?action=get")
      .then(res => res.json())
      .then(data => {
        const record = data.find(row => row[0] === name);
        if (record) {
          const [_, food, drink] = record;
          renderItemSection("food-section", "food", food.split(/,|\s+/).filter(Boolean));
          renderItemSection("drink-section", "drink", drink.split(/,|\s+/).filter(Boolean));
        } else {
          renderItemSection("food-section", "food");
          renderItemSection("drink-section", "drink");
        }
      });
  });

  // 初始化空表單
  renderItemSection("food-section", "food");
  renderItemSection("drink-section", "drink");
  loadOrders();
</script>
</body>
</html>
